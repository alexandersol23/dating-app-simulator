<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dating App Simulator</title>

  <style>
    :root { --border: rgba(0,0,0,.12); --shadow: rgba(0,0,0,.10); }

    body{
      margin:0; min-height:100vh; display:flex; justify-content:center; align-items:center;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:#f6f6f7; padding:18px;
    }

    .phone{
      width:min(420px, 96vw);
      background:#fff;
      border:1px solid var(--border);
      border-radius:22px;
      overflow:hidden;
      box-shadow:0 16px 40px var(--shadow);
    }

    .topbar{
      display:flex; justify-content:space-between; align-items:center;
      padding:14px;
      border-bottom:1px solid rgba(0,0,0,.08);
      font-weight:800;
      background:#fff;
    }

    .progress{
      font-size:12px; opacity:.7;
      border:1px solid rgba(0,0,0,.12);
      padding:6px 10px; border-radius:999px;
      white-space:nowrap;
    }

    .photo{ width:100%; aspect-ratio:4/5; background:#eee; }
    .photo img{ width:100%; height:100%; object-fit:cover; display:block; }

    .info{ padding:12px 14px 10px; }
    .nameage{ font-size:22px; font-weight:900; margin:0; }
    .bio{ margin:8px 0 0 0; font-size:14px; line-height:1.35; opacity:.9; }

    .panel{
      padding:14px;
      border-top:1px solid rgba(0,0,0,.08);
      background:#fff;
    }

    /* ‚úÖ Fixes the ‚Äútoo wide / overflow‚Äù issue */
    textarea{
      width:100%;
      box-sizing:border-box;   /* critical */
      display:block;           /* avoid inline weirdness */
      border:1px solid rgba(0,0,0,.18);
      border-radius:14px;
      padding:12px;
      font-size:14px;
      resize:none;
      outline:none;
      margin:0;                /* avoid default margins */
      max-width:100%;          /* belt + suspenders */
    }
    textarea:focus{ border-color: rgba(0,0,0,.35); }

    button{
      width:100%;
      margin-top:12px;
      background:#2d6cdf;
      color:#fff;
      border:none;
      border-radius:14px;
      padding:12px;
      font-weight:800;
      opacity:.55;
    }
    button.enabled{ opacity:1; cursor:pointer; }

    .hint{ font-size:12px; opacity:.7; margin-top:10px; line-height:1.3; }

    /* Inbox styles (enhanced) */
.inboxHeader{
  padding:12px 14px;
  border-bottom:1px solid rgba(0,0,0,.08);
  font-weight:900;
  background:#fff;
}

.thread{
  display:flex;
  gap:12px;
  padding:12px 14px;
  border-bottom:1px solid rgba(0,0,0,.06);
  background:#fff;
  align-items:flex-start;
}

.avatar{
  width:42px;
  height:42px;
  border-radius:50%;
  background:#e0e0e0; /* placeholder circle */
  flex-shrink:0;
  position:relative;
}

.dot{
  width:10px;
  height:10px;
  border-radius:50%;
  position:absolute;
  bottom:-2px;
  right:-2px;
  border:2px solid #fff;
}

.dot.blue{ background:#2d6cdf; }
.dot.red{ background:#e53935; }

.threadBody{
  flex:1;
}

.threadTop{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:4px;
}

.threadName{ font-weight:900; }
.threadTime{ font-size:12px; opacity:.6; white-space:nowrap; }
.threadMsg{ font-size:13px; opacity:.9; line-height:1.25; }

.badge{
  display:inline-block;
  font-size:11px;
  padding:3px 8px;
  border-radius:999px;
  background:#e53935;
  color:#fff;
  margin-left:6px;
}
    .emptyInbox{
  padding:18px 14px;
  font-size:13px;
  opacity:.75;
  line-height:1.35;
  background:#fff;
  border-bottom:1px solid rgba(0,0,0,.06);
}

/* --- PASSIVE (SWIPE) UI --- */
.swipeRow{
  display:flex;
  gap:12px;
}
.swipeBtn{
  flex:1;
  margin-top:12px;
  border:none;
  border-radius:14px;
  padding:12px;
  font-weight:900;
  cursor:pointer;
  opacity:1;
  color:#fff;
}
.swipeBtn.left{ background:#9e9e9e; }
.swipeBtn.right{ background:#2d6cdf; }

  </style>
</head>

<body>
  <div class="phone">

    <div class="topbar">
  <div id="title">
    Discover
    <span id="debugCond" style="font-size:12px; opacity:.55; margin-left:8px; font-weight:700;"></span>
  </div>
  <div class="progress" id="progress">1 / 15</div>
</div>

  <!-- INSTRUCTION VIEW (new) -->
<div id="introView">
  <div style="padding:14px;">
    <div style="font-weight:900; font-size:18px; margin-bottom:10px;">
      Dating App Messaging Simulation
    </div>

    <div style="font-size:13px; line-height:1.4; opacity:.9;">
      You will see a series of profiles. For <strong>each profile</strong>, send <strong>one message</strong>.
      Your message must be <strong>at least one complete sentence</strong>, and should be based on what you see
      (photo, bio, age). Anything is okay as long as it feels natural.
      <br><br>
      To make this realistic, write as if the person may read your message.
      After you message everyone, you‚Äôll see an inbox screen with <strong>imagined replies</strong> as feedback.
    </div>

    <button id="startBtn" class="enabled" style="opacity:1; cursor:pointer; margin-top:14px;">
      Start
    </button>

    <div style="font-size:12px; opacity:.7; margin-top:10px; line-height:1.3;">
      Please complete all messages to continue.
    </div>
  </div>
</div>

    <!-- PROFILE VIEW -->
   <div id="profileView" style="display:none;">
      <div class="photo">
        <img id="img" src="" alt="Profile photo">
      </div>

      <div class="info">
        <p class="nameage" id="nameage"></p>
        <p class="bio" id="bio"></p>
      </div>

      <div class="panel">
  <!-- ACTIVE: message UI -->
  <div id="messagePanel">
    <textarea id="msg" rows="3" maxlength="240" placeholder="Write a message‚Ä¶"></textarea>
    <button id="nextBtn" disabled>Send message & continue</button>
    <div class="hint" id="activeHint">Please send a message before continuing.</div>
  </div>

  <!-- PASSIVE: swipe UI -->
  <div id="swipePanel" style="display:none;">
    <div class="hint" style="margin-top:0;">Swipe to continue.</div>
    <div class="swipeRow">
      <button id="swipeLeftBtn" class="swipeBtn left" type="button">Swipe Left</button>
      <button id="swipeRightBtn" class="swipeBtn right" type="button">Swipe Right</button>
    </div>
  </div>
</div>

    </div>
    

    <!-- INBOX VIEW (after 15 profiles) -->
    <div id="inboxView" style="display:none;">
      <div class="inboxHeader">
  Inbox <span class="badge" id="badgeCount">6</span>
</div>


      <div id="threads"></div>

      <div class="panel">
        <button id="continueBtn" class="enabled" style="opacity:1; cursor:pointer; margin-top:0;">
      Continue the Study
      </button>

        <div class="hint">You can now continue to the next part of the study.</div>
      </div>
    </div>

  </div>

<script>
  // ---- 1) Config ----
  const params = new URLSearchParams(location.search);

const cond = (params.get("cond") || "active_high").toLowerCase();      // active_high / active_low / passive_high / passive_low
const target = (params.get("target") || "women").toLowerCase();       // men / women

// Qualtrics return link (if missing, fall back to your survey link)
const returnUrl = params.get("return") ||
  "https://qualtricsxmp86xgb4gq.qualtrics.com/jfe/form/SV_8p4wD7wS8EwXMns";

const isActive = cond.startsWith("active");
const isHigh = cond.endsWith("high");
const debugEl = document.getElementById("debugCond");
if (debugEl) debugEl.textContent = `(${cond})`;

 // required for final redirect

  // ---- 2) Profiles (15) ----
  // Replace img URLs with your AI image URLs (direct links like https://i.imgur.com/xxxx.png)
  const PROFILES_MEN = [
  {
    id:"p01", name:"Alex", age:21, img:"https://i.imgur.com/fOCWnxj.png",
    bio:[
      "Still figuring out what I want, but I know I like the ocean, quiet mornings, and people who don‚Äôt take themselves too seriously."
    ]
  },
  {
    id:"p02", name:"Ethan", age:22, img:"https://i.imgur.com/REPLACE02.png",
    bio:[
      "I run on coffee and deadlines. Probably overthinking this bio. If you have a favorite caf√©, I want to hear about it."
    ]
  },
  {
    id:"p03", name:"Ryan", age:20, img:"https://i.imgur.com/REPLACE03.png",
    bio:[
      "Into photography lately. Mostly streets, sometimes people. Bad at posing, better behind the camera."
    ]
  },
  {
    id:"p04", name:"Noah", age:23, img:"https://i.imgur.com/REPLACE04.png",
    bio:[
      "Grew up playing basketball, still do when I can. Trying to learn how to cook something other than pasta."
    ]
  },
  {
    id:"p05", name:"Lucas", age:21, img:"https://i.imgur.com/REPLACE05.png",
    bio:[
      "Climbing gyms scare me a little but I keep going back. Movie nights > parties, most of the time."
    ]
  },
  {
    id:"p06", name:"Jay", age:24, img:"https://i.imgur.com/REPLACE06.png",
    bio:[
      "I like long walks, vinyl records, and conversations that drift a bit. Not great at small talk, better after the second coffee."
    ]
  },
  {
    id:"p07", name:"Ben", age:22, img:"https://i.imgur.com/REPLACE07.png",
    bio:[
      "Usually outdoors on weekends if the weather cooperates. Reads a lot, remembers very little of it."
    ]
  },
  {
    id:"p08", name:"Chris", age:21, img:"https://i.imgur.com/REPLACE08.png",
    bio:[
      "Pretty laid-back. I like games, late-night snacks, and people who laugh easily."
    ]
  },
  {
    id:"p09", name:"Leo", age:23, img:"https://i.imgur.com/REPLACE09.png",
    bio:[
      "Architecture student. Always noticing buildings, probably judging them. Coffee order is boring but reliable."
    ]
  },
  {
    id:"p10", name:"Sam", age:20, img:"https://i.imgur.com/REPLACE10.png",
    bio:[
      "Learning guitar very slowly. If you have song recommendations, that‚Äôs already a good start."
    ]
  },
  {
    id:"p11", name:"Aaron", age:24, img:"https://i.imgur.com/REPLACE11.png",
    bio:[
      "Trying to be more consistent at the gym and less consistent with takeout. Mixed results so far."
    ]
  },
  {
    id:"p12", name:"Daniel", age:22, img:"https://i.imgur.com/REPLACE12.png",
    bio:[
      "People say I‚Äôm confident because I like karaoke. The truth is I just commit once I‚Äôm already on stage."
    ]
  },
  {
    id:"p13", name:"Mark", age:23, img:"https://i.imgur.com/REPLACE13.png",
    bio:[
      "I bike everywhere and listen to too many podcasts. Ask me what I‚Äôm listening to this week."
    ]
  },
  {
    id:"p14", name:"Owen", age:21, img:"https://i.imgur.com/REPLACE14.png",
    bio:[
      "Big fan of quiet galleries and noisy bubble tea places. Still undecided which one I like more."
    ]
  },
  {
    id:"p15", name:"Tyler", age:22, img:"https://i.imgur.com/REPLACE15.png",
    bio:[
      "Not great at bios. Better in person. I like tennis, short trips, and spontaneous plans that actually work out."
    ]
  }
];
const PROFILES_WOMEN = PROFILES_MEN; // TEMP: will replace later
const PROFILES = (target === "men") ? PROFILES_MEN : PROFILES_WOMEN;

  // ---- 3) Inbox (6 replies) ----
  // You can edit these to match your profiles/vibe.
  const HIGH_REPLIES = [
  {name:"Ethan",  time:"Just now", msg:"Hey! Coffee walks sound perfect ‚Äî what‚Äôs your go-to order?"},
  {name:"Owen",   time:"1m",       msg:"Matcha fan here too. Any spots you‚Äôd recommend around campus?"},
  {name:"Lucas",  time:"3m",       msg:"Bouldering beginner squad ü§ù what‚Äôs the coolest wall you‚Äôve tried so far?"},
  {name:"Sam",    time:"6m",       msg:"Guitar learner too ‚Äî what song are you working on right now?"},
  {name:"Noah",   time:"10m",      msg:"Ramen debate time: tonkotsu or miso? (choose wisely)"},
  {name:"Tyler",  time:"15m",      msg:"If we planned a quick weekend trip, where are we going first?"}
];

const LOW_REPLIES = [];

const INBOX_REPLIES = isHigh ? HIGH_REPLIES : LOW_REPLIES;

  // ---- 4) State / Elements ----
  let idx = 0;
  const responses = {}; // msg_p01...msg_p15
  let profileStartTs = null;

  const profileView = document.getElementById("profileView");
  const inboxView   = document.getElementById("inboxView");
  const introView   = document.getElementById("introView");
  const startBtn    = document.getElementById("startBtn");
  startBtn.addEventListener("click", () => {
  introView.style.display = "none";
  profileView.style.display = "block";
  setupModeUI(); // ‚úÖ add this
  loadProfile(); // starts profile 1
});


  const imgEl    = document.getElementById("img");
  const nameage  = document.getElementById("nameage");
  const bioEl    = document.getElementById("bio");
  const msgEl    = document.getElementById("msg");
  const nextBtn  = document.getElementById("nextBtn");
  const progEl   = document.getElementById("progress");
  const messagePanel = document.getElementById("messagePanel");
  const swipePanel   = document.getElementById("swipePanel");
  const swipeLeftBtn = document.getElementById("swipeLeftBtn");
  const swipeRightBtn= document.getElementById("swipeRightBtn");

  function setupModeUI(){
  if (isActive){
    messagePanel.style.display = "block";
    swipePanel.style.display = "none";
  } else {
    messagePanel.style.display = "none";
    swipePanel.style.display = "block";
  }
}

  function loadProfile() {
    const p = PROFILES[idx];
    imgEl.src = p.img;
    nameage.textContent = `${p.name}, ${p.age}`;
    bioEl.innerHTML = p.bio.join("<br>");

      if (isActive) {
    msgEl.value = "";
    nextBtn.disabled = true;
    nextBtn.classList.remove("enabled");
  }
    progEl.textContent = `${idx + 1} / ${PROFILES.length}`;
    profileStartTs = Date.now();
  }

  function isCompleteSentence(text){
  const t = text.trim();
  if (t.length < 6) return false; // too short
  const words = t.split(/\s+/).filter(Boolean);
  if (words.length < 3) return false; // at least 3 words
  return /[.!?]$/.test(t); // must end with punctuation
}

msgEl.addEventListener("input", () => {
  if (!isActive) return; // passive ignores

  const ok = isCompleteSentence(msgEl.value);
  nextBtn.disabled = !ok;
  nextBtn.classList.toggle("enabled", ok);
});


  function advanceAfterProfile(){
  idx++;
  if (idx < PROFILES.length) {
    loadProfile();
  } else {
    showInbox();
  }
}

  nextBtn.addEventListener("click", () => {
  if (!isActive) return; // ‚úÖ ignore in passive mode

  const p = PROFILES[idx];
  responses[`tstart_${p.id}`] = profileStartTs;
  responses[`tdwell_${p.id}`] = (profileStartTs ? (Date.now() - profileStartTs) : "");
  responses[`msg_${p.id}`] = msgEl.value.trim();

  advanceAfterProfile();
});
  
function recordSwipe(choice){
  const p = PROFILES[idx];
  responses[`tstart_${p.id}`] = profileStartTs;
  responses[`tdwell_${p.id}`] = (profileStartTs ? (Date.now() - profileStartTs) : "");
  responses[`swipe_${p.id}`] = choice; // swipe_p01 = left/right
  responses[`msg_${p.id}`] = "";       // optional: keep message keys consistent
  advanceAfterProfile();
}

swipeLeftBtn.addEventListener("click", () => {
  if (isActive) return;
  recordSwipe("left");
});

swipeRightBtn.addEventListener("click", () => {
  if (isActive) return;
  recordSwipe("right");
});

  function showInbox() {
    // Switch views
    profileView.style.display = "none";
    inboxView.style.display = "block";

    // Update top bar
    document.getElementById("title").textContent = "Messages";
    progEl.textContent = ""; // hide progress pill content without removing element

    // Render threads
    const threads = document.getElementById("threads");
    threads.innerHTML = "";
    // Update badge based on number of replies
const badge = document.getElementById("badgeCount");
const n = INBOX_REPLIES.length;

if (badge) {
  if (n === 0) {
    badge.style.display = "none";
  } else {
    badge.style.display = "inline-block";
    badge.textContent = String(n);
  }
}

// If no replies, show empty state
if (n === 0) {
  const empty = document.createElement("div");
  empty.className = "emptyInbox";
  empty.textContent = "No new messages yet.";
  threads.appendChild(empty);
  return; // stop here
}

   INBOX_REPLIES.forEach((r, i) => {
  const div = document.createElement("div");
  div.className = "thread";

  /* Alternate red dots for visual realism */
 const dotColor = "red";


  div.innerHTML = `
    <div class="avatar">
      <!-- profile image goes here later -->
      <div class="dot ${dotColor}"></div>
    </div>

    <div class="threadBody">
      <div class="threadTop">
        <div class="threadName">${escapeHtml(r.name)}</div>
        <div class="threadTime">${escapeHtml(r.time)}</div>
      </div>
      <div class="threadMsg">${escapeHtml(r.msg)}</div>
    </div>
  `;
  threads.appendChild(div);
});

  }

  // Continue -> redirect back to Qualtrics (or whatever returnUrl is)
  document.getElementById("continueBtn").addEventListener("click", () => {
  if (!returnUrl) {
    alert("Missing return URL. Add ?return=YOUR_QUALTRICS_LINK to the simulator URL.");
    return;
  }

    responses._meta = {
  cond,
  target,
  ts_end: Date.now()
};

  const payload = encodePayload({
    cond,
    target,
    responses
  });

  const sep = returnUrl.includes("?") ? "&" : "?";
  location.href = returnUrl + sep + "payload=" + payload;
});

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;"
    }[s]));
  }
  function encodePayload(obj){
  const json = JSON.stringify(obj);
  return btoa(unescape(encodeURIComponent(json)));
}

  // Init
// Wait for participant to click Start on the intro page
</script>

</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dating App Simulator</title>

  <style>
    :root { --border: rgba(0,0,0,.12); --shadow: rgba(0,0,0,.10); }

    body{
      margin:0; min-height:100vh; display:flex; justify-content:center; align-items:center;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:#f6f6f7; padding:18px;
    }

    .phone{
      width:min(420px, 96vw);
      background:#fff;
      border:1px solid var(--border);
      border-radius:22px;
      overflow:hidden;
      box-shadow:0 16px 40px var(--shadow);
    }

    .topbar{
      display:flex; justify-content:space-between; align-items:center;
      padding:14px;
      border-bottom:1px solid rgba(0,0,0,.08);
      font-weight:800;
      background:#fff;
    }

    .progress{
      font-size:12px; opacity:.7;
      border:1px solid rgba(0,0,0,.12);
      padding:6px 10px; border-radius:999px;
      white-space:nowrap;
    }

    .photo{ width:100%; aspect-ratio:4/5; background:#eee; }
    .photo img{ width:100%; height:100%; object-fit:cover; display:block; }

    .info{ padding:12px 14px 10px; }
    .nameage{ font-size:22px; font-weight:900; margin:0; }
    .bio{ margin:8px 0 0 0; font-size:14px; line-height:1.35; opacity:.9; }

    .panel{
      padding:14px;
      border-top:1px solid rgba(0,0,0,.08);
      background:#fff;
    }

    /* ‚úÖ Fixes the ‚Äútoo wide / overflow‚Äù issue */
    textarea{
      width:100%;
      box-sizing:border-box;   /* critical */
      display:block;           /* avoid inline weirdness */
      border:1px solid rgba(0,0,0,.18);
      border-radius:14px;
      padding:12px;
      font-size:14px;
      resize:none;
      outline:none;
      margin:0;                /* avoid default margins */
      max-width:100%;          /* belt + suspenders */
    }
    textarea:focus{ border-color: rgba(0,0,0,.35); }

    button{
      width:100%;
      margin-top:12px;
      background:#2d6cdf;
      color:#fff;
      border:none;
      border-radius:14px;
      padding:12px;
      font-weight:800;
      opacity:.55;
    }
    button.enabled{ opacity:1; cursor:pointer; }

    .hint{ font-size:12px; opacity:.7; margin-top:10px; line-height:1.3; }

    /* Inbox styles (enhanced) */
.inboxHeader{
  padding:12px 14px;
  border-bottom:1px solid rgba(0,0,0,.08);
  font-weight:900;
  background:#fff;
}

.thread{
  display:flex;
  gap:12px;
  padding:12px 14px;
  border-bottom:1px solid rgba(0,0,0,.06);
  background:#fff;
  align-items:flex-start;
}

.avatar{
  width:42px;
  height:42px;
  border-radius:50%;
  background:#e0e0e0; /* placeholder circle */
  flex-shrink:0;
  position:relative;
}

.dot{
  width:10px;
  height:10px;
  border-radius:50%;
  position:absolute;
  bottom:-2px;
  right:-2px;
  border:2px solid #fff;
}

.dot.blue{ background:#2d6cdf; }
.dot.red{ background:#e53935; }

.threadBody{
  flex:1;
}

.threadTop{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:4px;
}

.threadName{ font-weight:900; }
.threadTime{ font-size:12px; opacity:.6; white-space:nowrap; }
.threadMsg{ font-size:13px; opacity:.9; line-height:1.25; }

.badge{
  display:inline-block;
  font-size:11px;
  padding:3px 8px;
  border-radius:999px;
  background:#e53935;
  color:#fff;
  margin-left:6px;
}
    .emptyInbox{
  padding:18px 14px;
  font-size:13px;
  opacity:.75;
  line-height:1.35;
  background:#fff;
  border-bottom:1px solid rgba(0,0,0,.06);
}

/* --- PASSIVE (SWIPE) UI --- */
.swipeRow{
  display:flex;
  gap:12px;
}
.swipeBtn{
  flex:1;
  margin-top:12px;
  border:none;
  border-radius:14px;
  padding:12px;
  font-weight:900;
  cursor:pointer;
  opacity:1;
  color:#fff;
}
.swipeBtn.left{ background:#9e9e9e; }
.swipeBtn.right{ background:#2d6cdf; }

  </style>
</head>

<body>
  <div class="phone">

   <div class="topbar">
  <div id="title">Discover</div>
  <div class="progress" id="progress">1 / 15</div>
</div>

  <!-- INSTRUCTION VIEW (new) -->
<div id="introView">
  <div style="padding:14px;">
    <div id="introTitle" style="font-weight:900; font-size:18px; margin-bottom:10px;">
  Dating App Simulation
</div>

<div id="introBody" style="font-size:13px; line-height:1.4; opacity:.9;">
  <!-- This text will be filled by JavaScript based on condition -->
</div>


   <button id="startBtn" type="button" class="enabled"
  style="opacity:1; cursor:pointer; margin-top:14px;">
  Start
</button>


    <div style="font-size:12px; opacity:.7; margin-top:10px; line-height:1.3;">
      Please complete all messages to continue.
    </div>
  </div>
</div>

    <!-- PROFILE VIEW -->
   <div id="profileView" style="display:none;">
      <div class="photo">
        <img id="img" src="" alt="Profile photo">
      </div>

      <div class="info">
        <p class="nameage" id="nameage"></p>
        <p class="bio" id="bio"></p>
      </div>

      <div class="panel">
  <!-- ACTIVE: message UI -->
  <div id="messagePanel">
    <textarea id="msg" rows="3" maxlength="240" placeholder="Write a message‚Ä¶"></textarea>
    <button id="nextBtn" disabled>Send message & continue</button>
    <div class="hint" id="activeHint">Please send a message before continuing.</div>
  </div>

  <!-- PASSIVE: swipe UI -->
  <div id="swipePanel" style="display:none;">
    <div class="hint" style="margin-top:0;">Swipe to continue.</div>
    <div class="swipeRow">
      <button id="swipeLeftBtn" class="swipeBtn left" type="button">Swipe Left</button>
      <button id="swipeRightBtn" class="swipeBtn right" type="button">Swipe Right</button>
    </div>
  </div>
</div>

    </div>
    

    <!-- INBOX VIEW (after 15 profiles) -->
    <div id="inboxView" style="display:none;">
      <div class="inboxHeader">
  Inbox <span class="badge" id="badgeCount">6</span>
</div>


      <div id="threads"></div>

      <div class="panel">
       <button id="continueBtn" type="button" class="enabled" style="opacity:1; cursor:pointer; margin-top:0;">
  Continue the Study
</button>

        <div class="hint">You can now continue to the next part of the study.</div>
      </div>
    </div>

  </div>

<script>
window.addEventListener("DOMContentLoaded", () => {
  // ---- 1) Config ----
  const params = new URLSearchParams(location.search);

  const cond = (params.get("cond") || "active_high").toLowerCase().trim(); // active_high / active_low / passive_high / passive_low

  // Robust target parsing (accept men/male/man; women/female/woman)
  const rawTarget = (params.get("target") || "women").toLowerCase().trim();
  const target =
    (rawTarget === "men" || rawTarget === "male" || rawTarget === "man") ? "men" :
    (rawTarget === "women" || rawTarget === "female" || rawTarget === "woman") ? "women" :
    "women";

  const continueBtn = document.getElementById("continueBtn");

if (!continueBtn) {
  console.error("ERROR: continueBtn not found in DOM.");
} else {
  continueBtn.addEventListener("click", () => {
    try {
      console.log("Continue clicked.");

      const payloadObj = { cond, target, responses };
      const payload = encodePayload(payloadObj);

      // Helpful debug: see if URL is getting insanely long
      console.log("Payload length:", payload.length);

      const joiner = returnUrl.includes("?") ? "&" : "?";
      const dest = returnUrl + joiner + "payload=" + encodeURIComponent(payload);

      console.log("Redirecting to:", dest);

      window.location.href = dest;
    } catch (e) {
      console.error("ERROR during continue redirect:", e);
      alert("Something went wrong sending you back to the survey. Please screenshot the console error and send it to the researcher.");
    }
  });
}
  const isActive = cond.startsWith("active");
  const isHigh = cond.endsWith("high");
  function renderIntroInstructions() {
  const titleEl = document.getElementById("introTitle");
  const bodyEl  = document.getElementById("introBody");

  if (!titleEl || !bodyEl) return;

  if (isActive) {
    // ACTIVE (messaging) instructions
    titleEl.textContent = "Dating App Messaging Simulation";
    bodyEl.innerHTML = `
      You will see a series of profiles. For <strong>each profile</strong>, send <strong>one message</strong>.
      Your message must be <strong>at least one complete sentence</strong>, and should be based on what you see
      (photo, bio, age). Anything is okay as long as it feels natural.
      <br><br>
      To make this realistic, write as if the person may read your message.
      After you message everyone, you‚Äôll see an inbox screen with <strong>imagined replies</strong> as feedback.
    `;
  } else {
    // PASSIVE (swiping) instructions
    titleEl.textContent = "Dating App Swiping Simulation";
    bodyEl.innerHTML = `
      You will see a series of profiles. For <strong>each profile</strong>, choose <strong>Swipe Left</strong>
      or <strong>Swipe Right</strong> based on your immediate impression.
      <br><br>
      After you finish viewing everyone, you‚Äôll see an inbox screen with <strong>imagined feedback</strong>.
      <br><br>
      Please make one swipe decision per profile to continue.
    `;
  }
}

  // Researcher-only debug (does NOT show to participants)
  console.log("cond =", cond, "rawTarget =", rawTarget, "normalized target =", target);

  // ---- 2) Profiles ----
  const PROFILES_MEN = [
    { id:"p01", name:"Alex",   age:21, img:"https://i.imgur.com/fOCWnxj.png", bio:["Still figuring out what I want, but I know I like the ocean, quiet mornings, and people who don‚Äôt take themselves too seriously."] },
    { id:"p02", name:"Ethan",  age:22, img:"https://i.imgur.com/REPLACE02.png", bio:["I run on coffee and deadlines. Probably overthinking this bio. If you have a favorite caf√©, I want to hear about it."] },
    { id:"p03", name:"Ryan",   age:20, img:"https://i.imgur.com/REPLACE03.png", bio:["Into photography lately. Mostly streets, sometimes people. Bad at posing, better behind the camera."] },
    { id:"p04", name:"Noah",   age:23, img:"https://i.imgur.com/REPLACE04.png", bio:["Grew up playing basketball, still do when I can. Trying to learn how to cook something other than pasta."] },
    { id:"p05", name:"Lucas",  age:21, img:"https://i.imgur.com/REPLACE05.png", bio:["Climbing gyms scare me a little but I keep going back. Movie nights > parties, most of the time."] },
    { id:"p06", name:"Jay",    age:24, img:"https://i.imgur.com/REPLACE06.png", bio:["I like long walks, vinyl records, and conversations that drift a bit. Not great at small talk, better after the second coffee."] },
    { id:"p07", name:"Ben",    age:22, img:"https://i.imgur.com/REPLACE07.png", bio:["Usually outdoors on weekends if the weather cooperates. Reads a lot, remembers very little of it."] },
    { id:"p08", name:"Chris",  age:21, img:"https://i.imgur.com/REPLACE08.png", bio:["Pretty laid-back. I like games, late-night snacks, and people who laugh easily."] },
    { id:"p09", name:"Leo",    age:23, img:"https://i.imgur.com/REPLACE09.png", bio:["Architecture student. Always noticing buildings, probably judging them. Coffee order is boring but reliable."] },
    { id:"p10", name:"Sam",    age:20, img:"https://i.imgur.com/REPLACE10.png", bio:["Learning guitar very slowly. If you have song recommendations, that‚Äôs already a good start."] },
    { id:"p11", name:"Aaron",  age:24, img:"https://i.imgur.com/REPLACE11.png", bio:["Trying to be more consistent at the gym and less consistent with takeout. Mixed results so far."] },
    { id:"p12", name:"Daniel", age:22, img:"https://i.imgur.com/REPLACE12.png", bio:["People say I‚Äôm confident because I like karaoke. The truth is I just commit once I‚Äôm already on stage."] },
    { id:"p13", name:"Mark",   age:23, img:"https://i.imgur.com/REPLACE13.png", bio:["I bike everywhere and listen to too many podcasts. Ask me what I‚Äôm listening to this week."] },
    { id:"p14", name:"Owen",   age:21, img:"https://i.imgur.com/REPLACE14.png", bio:["Big fan of quiet galleries and noisy bubble tea places. Still undecided which one I like more."] },
    { id:"p15", name:"Tyler",  age:22, img:"https://i.imgur.com/REPLACE15.png", bio:["Not great at bios. Better in person. I like tennis, short trips, and spontaneous plans that actually work out."] }
  ];

  const PROFILES_WOMEN = [
    { id:"w01", name:"Emily",    age:21, img:"https://i.imgur.com/REPLACE_W01.png", bio:["Into long walks with podcasts, trying new caf√©s, and pretending I don‚Äôt like reality TV."] },
    { id:"w02", name:"Sophia",   age:22, img:"https://i.imgur.com/REPLACE_W02.png", bio:["I like photography, museums, and sitting by windows when it rains. Coffee order is always changing."] },
    { id:"w03", name:"Hannah",   age:20, img:"https://i.imgur.com/REPLACE_W03.png", bio:["Currently balancing school, Pilates, and figuring out what I actually want to do after graduation."] },
    { id:"w04", name:"Olivia",   age:23, img:"https://i.imgur.com/REPLACE_W04.png", bio:["Big fan of farmer‚Äôs markets, quiet mornings, and cooking something new every week."] },
    { id:"w05", name:"Maya",     age:21, img:"https://i.imgur.com/REPLACE_W05.png", bio:["Always planning my next short trip. I love good playlists and conversations that wander."] },
    { id:"w06", name:"Lily",     age:24, img:"https://i.imgur.com/REPLACE_W06.png", bio:["I work out a lot but also really enjoy dessert. Trying to keep life balanced."] },
    { id:"w07", name:"Ava",      age:22, img:"https://i.imgur.com/REPLACE_W07.png", bio:["Bookstores > bars most nights. Ask me what I‚Äôm reading right now."] },
    { id:"w08", name:"Isabella", age:21, img:"https://i.imgur.com/REPLACE_W08.png", bio:["I like spontaneous plans that actually work out. Big fan of late dinners and long talks."] },
    { id:"w09", name:"Grace",    age:23, img:"https://i.imgur.com/REPLACE_W09.png", bio:["Usually biking around the city or listening to way too many podcasts."] },
    { id:"w10", name:"Natalie",  age:20, img:"https://i.imgur.com/REPLACE_W10.png", bio:["Learning how to cook one recipe at a time. Open to recommendations."] },
    { id:"w11", name:"Zoe",      age:24, img:"https://i.imgur.com/REPLACE_W11.png", bio:["I like climbing gyms, film photography, and conversations that go a little deep."] },
    { id:"w12", name:"Chloe",    age:22, img:"https://i.imgur.com/REPLACE_W12.png", bio:["Big believer in walking everywhere. Still deciding if mornings or nights suit me better."] },
    { id:"w13", name:"Samantha", age:23, img:"https://i.imgur.com/REPLACE_W13.png", bio:["Trying to be more consistent with yoga and less consistent with scrolling."] },
    { id:"w14", name:"Ella",     age:21, img:"https://i.imgur.com/REPLACE_W14.png", bio:["I love galleries, matcha, and places that feel a little hidden."] },
    { id:"w15", name:"Julia",    age:22, img:"https://i.imgur.com/REPLACE_W15.png", bio:["Not great at writing bios. Better at conversations once they start."] }
  ];

  const PROFILES = (target === "men") ? PROFILES_MEN : PROFILES_WOMEN;

  // ---- 3) Inbox replies ----
  const HIGH_REPLIES_MEN = [
    {name:"Ethan",  time:"Just now", msg:"Hey! Coffee walks sound perfect ‚Äî what‚Äôs your go-to order?"},
    {name:"Owen",   time:"1m",       msg:"Matcha fan here too. Any spots you‚Äôd recommend around campus?"},
    {name:"Lucas",  time:"3m",       msg:"Bouldering beginner squad ü§ù what‚Äôs the coolest wall you‚Äôve tried so far?"},
    {name:"Sam",    time:"6m",       msg:"Guitar learner too ‚Äî what song are you working on right now?"},
    {name:"Noah",   time:"10m",      msg:"Ramen debate time: tonkotsu or miso? (choose wisely)"},
    {name:"Tyler",  time:"15m",      msg:"If we planned a quick weekend trip, where are we going first?"}
  ];

  const HIGH_REPLIES_WOMEN = [
    {name:"Emily",   time:"Just now", msg:"Hey! Your message was really thoughtful ‚Äî what got you into that?"},
    {name:"Sophia",  time:"2m",       msg:"I liked what you said about caf√©s. Do you have a favorite spot lately?"},
    {name:"Maya",    time:"4m",       msg:"Travel planning is my weakness too üòÖ what kind of trips do you like most?"},
    {name:"Ava",     time:"7m",       msg:"Bookstore dates are underrated. What are you reading right now?"},
    {name:"Lily",    time:"11m",      msg:"Balance is hard lol ‚Äî do you have a favorite workout or class?"},
    {name:"Julia",   time:"16m",      msg:"Not great at bios either, but your message made it easy to reply üôÇ"}
  ];

  const LOW_REPLIES = [];

  // ‚úÖ Replies should come from the SAME profiles the participant viewed
const INBOX_REPLIES_BASE = isHigh
  ? (target === "men" ? HIGH_REPLIES_MEN : HIGH_REPLIES_WOMEN)
  : LOW_REPLIES;


  // ---- 4) State / Elements ----
  let idx = 0;
  const responses = {};
  let profileStartTs = null;

  const introView   = document.getElementById("introView");
  const profileView = document.getElementById("profileView");
  const inboxView   = document.getElementById("inboxView");

  const imgEl    = document.getElementById("img");
  const nameage  = document.getElementById("nameage");
  const bioEl    = document.getElementById("bio");

  const msgEl    = document.getElementById("msg");
  const nextBtn  = document.getElementById("nextBtn");

  const progEl   = document.getElementById("progress");

  const messagePanel = document.getElementById("messagePanel");
  const swipePanel   = document.getElementById("swipePanel");
  const swipeLeftBtn = document.getElementById("swipeLeftBtn");
  const swipeRightBtn= document.getElementById("swipeRightBtn");

  const startBtn = document.getElementById("startBtn");
  renderIntroInstructions();

  function setupModeUI(){
    if (isActive){
      messagePanel.style.display = "block";
      swipePanel.style.display = "none";
    } else {
      messagePanel.style.display = "none";
      swipePanel.style.display = "block";
    }
  }

  function loadProfile() {
    const p = PROFILES[idx];
    imgEl.src = p.img;
    nameage.textContent = `${p.name}, ${p.age}`;
    bioEl.innerHTML = p.bio.join("<br>");

    progEl.textContent = `${idx + 1} / ${PROFILES.length}`;

    if (isActive) {
      msgEl.value = "";
      nextBtn.disabled = true;
      nextBtn.classList.remove("enabled");
    }

    profileStartTs = Date.now();
  }

  function advanceAfterProfile(){
    idx++;
    if (idx < PROFILES.length) loadProfile();
    else showInbox();
  }

  // Active: enable button for ANY non-empty text
  msgEl.addEventListener("input", () => {
    if (!isActive) return;
    const ok = msgEl.value.trim().length > 0;
    nextBtn.disabled = !ok;
    nextBtn.classList.toggle("enabled", ok);
  });

  nextBtn.addEventListener("click", () => {
    if (!isActive) return;

    const p = PROFILES[idx];
    responses[`tstart_${p.id}`] = profileStartTs;
    responses[`tdwell_${p.id}`] = profileStartTs ? (Date.now() - profileStartTs) : "";
    responses[`msg_${p.id}`] = msgEl.value.trim();

    advanceAfterProfile();
  });

  function recordSwipe(choice){
    const p = PROFILES[idx];
    responses[`tstart_${p.id}`] = profileStartTs;
    responses[`tdwell_${p.id}`] = profileStartTs ? (Date.now() - profileStartTs) : "";
    responses[`swipe_${p.id}`] = choice;
    responses[`msg_${p.id}`] = "";
    advanceAfterProfile();
  }

  swipeLeftBtn.addEventListener("click", () => {
    if (isActive) return;
    recordSwipe("left");
  });

  swipeRightBtn.addEventListener("click", () => {
    if (isActive) return;
    recordSwipe("right");
  });

  function getRightSwipesSet(){
    const set = new Set();
    PROFILES.forEach(p => {
      if (responses[`swipe_${p.id}`] === "right") set.add(p.id);
    });
    return set;
  }

  function showInbox() {
    profileView.style.display = "none";
    inboxView.style.display = "block";

    document.getElementById("title").textContent = "Messages";
    progEl.textContent = "";

    const threads = document.getElementById("threads");
    threads.innerHTML = "";

    let repliesToShow = INBOX_REPLIES_BASE;

    // Passive + High: only replies from right-swipes
    if (!isActive && isHigh) {
      const rightSet = getRightSwipesSet();
      repliesToShow = INBOX_REPLIES_BASE.filter(r => {
        const prof = PROFILES.find(p => p.name === r.name);
        return prof && rightSet.has(prof.id);
      });
    }

    const badge = document.getElementById("badgeCount");
    const n = repliesToShow.length;

    if (badge) {
      badge.style.display = n === 0 ? "none" : "inline-block";
      badge.textContent = String(n);
    }

    if (n === 0) {
      const empty = document.createElement("div");
      empty.className = "emptyInbox";
      empty.textContent = "No new messages yet.";
      threads.appendChild(empty);
      return;
    }

    repliesToShow.forEach((r) => {
      const div = document.createElement("div");
      div.className = "thread";
      div.innerHTML = `
        <div class="avatar"><div class="dot red"></div></div>
        <div class="threadBody">
          <div class="threadTop">
            <div class="threadName">${escapeHtml(r.name)}</div>
            <div class="threadTime">${escapeHtml(r.time)}</div>
          </div>
          <div class="threadMsg">${escapeHtml(r.msg)}</div>
        </div>
      `;
      threads.appendChild(div);
    });
  }

  // Start button: JS version (you can remove inline onclick after this works)
  startBtn.addEventListener("click", () => {
    introView.style.display = "none";
    profileView.style.display = "block";
    setupModeUI();
    loadProfile();
  });

  document.getElementById("continueBtn").addEventListener("click", () => {
  const payloadObj = {
    cond,
    target,
    responses
  };

  const payload = encodePayload(payloadObj);
  const joiner = returnUrl.includes("?") ? "&" : "?";

  window.location.href =
    returnUrl + joiner + "payload=" + encodeURIComponent(payload);
});

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;"
    }[s]));
  }

  function encodePayload(obj){
    const json = JSON.stringify(obj);
    return btoa(unescape(encodeURIComponent(json)));
  }
});
</script>


</body>
</html>
